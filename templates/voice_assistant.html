<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loop AI Hospital Network Assistant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 550px;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        .header h1 { font-size: 24px; font-weight: 600; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .main-content { padding: 30px; }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .control-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            font-size: 12px;
            color: white;
        }
        .mic-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }
        .mic-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(16, 185, 129, 0.4); }
        .mic-btn.listening {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: pulse 1.5s infinite;
        }
        .speaker-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }
        .speaker-btn.speaking {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            animation: pulse 1s infinite;
        }
        .control-btn svg { width: 30px; height: 30px; fill: white; margin-bottom: 5px; }
        
        .status-label {
            text-align: center;
            font-size: 16px;
            color: #374151;
            margin-bottom: 20px;
            font-weight: 500;
            min-height: 24px;
        }
        
        .conversation-container {
            background: #f8fafc;
            border-radius: 16px;
            padding: 15px;
            max-height: 320px;
            overflow-y: auto;
        }
        .message {
            margin-bottom: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.5;
        }
        .user-message {
            background: #2563eb;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .assistant-message {
            background: white;
            color: #374151;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 4px;
        }
        .welcome-message {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
        }
        
        .input-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .text-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            font-size: 14px;
            outline: none;
        }
        .text-input:focus { border-color: #2563eb; }
        .send-button {
            padding: 12px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
        }
        .send-button:hover { background: #1d4ed8; }
        
        .typing-indicator {
            display: none;
            text-align: center;
            color: #6b7280;
            font-style: italic;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .voice-toggle {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #6b7280;
        }
        .voice-toggle input { width: 18px; height: 18px; cursor: pointer; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Loop AI Hospital Network Assistant</h1>
            <p>Voice-enabled hospital search and verification</p>
        </div>
        
        <div class="main-content">
            <div class="controls">
                <button id="micButton" class="control-btn mic-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                    <span>Speak</span>
                </button>
                <button id="stopSpeakBtn" class="control-btn speaker-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                    </svg>
                    <span>Stop</span>
                </button>
            </div>
            
            <div class="voice-toggle">
                <input type="checkbox" id="voiceResponseToggle" checked>
                <label for="voiceResponseToggle">Enable voice responses</label>
            </div>
            
            <div id="statusLabel" class="status-label">Click microphone to start speaking</div>

            <div class="conversation-container" id="conversationContainer">
                <div class="message assistant-message welcome-message">
                    <strong>Loop AI:</strong> Hello! I'm Loop AI, your Hospital Network Assistant. I can help you find hospitals in our network or verify coverage. Try saying "Find Apollo hospitals in Bangalore" or "Is Manipal Hospital in my network?"
                </div>
            </div>

            <div id="typingIndicator" class="typing-indicator">Loop AI is thinking...</div>

            <div class="input-container">
                <input type="text" id="textInput" class="text-input" placeholder="Or type your message here...">
                <button id="sendButton" class="send-button">Send</button>
            </div>
        </div>
    </div>

    <script>
        class VoiceAssistant {
            constructor() {
                this.isListening = false;
                this.isSpeaking = false;
                this.recognition = null;
                this.synthesis = window.speechSynthesis;
                this.sessionId = 'session_' + Date.now();
                this.voiceEnabled = true;
                
                this.conversationContainer = document.getElementById('conversationContainer');
                this.typingIndicator = document.getElementById('typingIndicator');
                this.statusLabel = document.getElementById('statusLabel');
                this.micButton = document.getElementById('micButton');
                this.stopSpeakBtn = document.getElementById('stopSpeakBtn');
                this.voiceToggle = document.getElementById('voiceResponseToggle');
                
                this.initializeVoiceRecognition();
                this.setupEventListeners();
                
                // Speak welcome message
                setTimeout(() => {
                    if (this.voiceToggle.checked) {
                        this.speak("Hello! I'm Loop AI, your Hospital Network Assistant. How can I help you today?");
                    }
                }, 500);
            }

            initializeVoiceRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    
                    this.recognition.continuous = false;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'en-IN';

                    this.recognition.onstart = () => {
                        this.isListening = true;
                        this.updateUI();
                        this.statusLabel.textContent = 'Listening... Speak now';
                    };

                    this.recognition.onresult = (event) => {
                        let finalTranscript = '';
                        let interimTranscript = '';
                        
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                finalTranscript += transcript;
                            } else {
                                interimTranscript += transcript;
                            }
                        }
                        
                        if (interimTranscript) {
                            this.statusLabel.textContent = `Hearing: "${interimTranscript}"`;
                        }
                        
                        if (finalTranscript) {
                            this.processVoiceInput(finalTranscript);
                        }
                    };

                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.isListening = false;
                        this.updateUI();
                        
                        if (event.error === 'no-speech') {
                            this.statusLabel.textContent = 'No speech detected. Try again.';
                        } else {
                            this.statusLabel.textContent = 'Error occurred. Please try again.';
                        }
                    };

                    this.recognition.onend = () => {
                        this.isListening = false;
                        this.updateUI();
                    };
                } else {
                    this.statusLabel.textContent = 'Voice not supported - use text input';
                    this.micButton.disabled = true;
                }
            }

            setupEventListeners() {
                this.micButton.addEventListener('click', () => this.toggleListening());
                this.stopSpeakBtn.addEventListener('click', () => this.stopSpeaking());
                document.getElementById('sendButton').addEventListener('click', () => this.sendTextMessage());
                document.getElementById('textInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendTextMessage();
                });
                this.voiceToggle.addEventListener('change', (e) => {
                    this.voiceEnabled = e.target.checked;
                    if (!e.target.checked) this.stopSpeaking();
                });
            }

            toggleListening() {
                // Stop any ongoing speech first
                this.stopSpeaking();
                
                if (!this.recognition) {
                    this.addMessage('Voice recognition is not supported. Please use text input.', 'assistant');
                    return;
                }

                if (this.isListening) {
                    this.recognition.stop();
                } else {
                    this.recognition.start();
                }
            }

            updateUI() {
                if (this.isListening) {
                    this.micButton.classList.add('listening');
                    this.statusLabel.textContent = 'Listening...';
                } else {
                    this.micButton.classList.remove('listening');
                    if (!this.isSpeaking) {
                        this.statusLabel.textContent = 'Click microphone to start speaking';
                    }
                }
                
                if (this.isSpeaking) {
                    this.stopSpeakBtn.classList.add('speaking');
                } else {
                    this.stopSpeakBtn.classList.remove('speaking');
                }
            }

            speak(text) {
                if (!this.voiceEnabled || !this.synthesis) return;
                
                // Cancel any ongoing speech
                this.synthesis.cancel();
                
                // Clean text for speech
                const cleanText = text.replace(/\n/g, '. ').replace(/\d+\./g, '');
                
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = 'en-IN';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                
                // Try to find a good voice
                const voices = this.synthesis.getVoices();
                const preferredVoice = voices.find(v => 
                    v.lang.includes('en') && (v.name.includes('Google') || v.name.includes('Female'))
                ) || voices.find(v => v.lang.includes('en'));
                
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                
                utterance.onstart = () => {
                    this.isSpeaking = true;
                    this.statusLabel.textContent = 'Speaking...';
                    this.updateUI();
                };
                
                utterance.onend = () => {
                    this.isSpeaking = false;
                    this.statusLabel.textContent = 'Click microphone to continue';
                    this.updateUI();
                };
                
                utterance.onerror = () => {
                    this.isSpeaking = false;
                    this.updateUI();
                };
                
                this.synthesis.speak(utterance);
            }

            stopSpeaking() {
                if (this.synthesis) {
                    this.synthesis.cancel();
                    this.isSpeaking = false;
                    this.updateUI();
                    this.statusLabel.textContent = 'Speech stopped';
                }
            }

            async processVoiceInput(transcript) {
                this.addMessage(transcript, 'user');
                await this.sendToAssistant(transcript);
            }

            async sendTextMessage() {
                const textInput = document.getElementById('textInput');
                const message = textInput.value.trim();

                if (message) {
                    this.addMessage(message, 'user');
                    textInput.value = '';
                    await this.sendToAssistant(message);
                }
            }

            async sendToAssistant(message) {
                this.showTypingIndicator();
                this.statusLabel.textContent = 'Processing...';

                try {
                    const response = await fetch('/api/conversation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: message,
                            session_id: this.sessionId
                        })
                    });

                    const data = await response.json();
                    this.hideTypingIndicator();
                    
                    this.addMessage(data.response, 'assistant');
                    
                    // Speak the response
                    if (this.voiceToggle.checked) {
                        this.speak(data.response);
                    } else {
                        this.statusLabel.textContent = 'Click microphone to continue';
                    }
                    
                    if (data.end_conversation) {
                        this.statusLabel.textContent = 'Conversation ended. Refresh to start new.';
                    }

                } catch (error) {
                    console.error('Error:', error);
                    this.hideTypingIndicator();
                    this.addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
                    this.statusLabel.textContent = 'Error occurred';
                }
            }

            addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                
                const label = sender === 'assistant' ? 'Loop AI' : 'You';
                messageDiv.innerHTML = `<strong>${label}:</strong> ${this.formatResponse(text)}`;

                this.conversationContainer.appendChild(messageDiv);
                this.conversationContainer.scrollTop = this.conversationContainer.scrollHeight;
            }

            formatResponse(text) {
                return text.replace(/\n/g, '<br>');
            }

            showTypingIndicator() {
                this.typingIndicator.style.display = 'block';
                this.conversationContainer.scrollTop = this.conversationContainer.scrollHeight;
            }

            hideTypingIndicator() {
                this.typingIndicator.style.display = 'none';
            }
        }

        // Initialize when voices are loaded
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = () => {
                window.speechSynthesis.getVoices();
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            new VoiceAssistant();
        });
    </script>
</body>
</html>
